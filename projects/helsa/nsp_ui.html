<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Helsa Nurse Scheduling Application</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 20px;
            overflow-x: hidden; /* Prevent horizontal overflow */
        }
        h1, h2 {
            color: #333;
        }
        /* Ribbon Bar Styling */
        .ribbon-bar {
            background-color: #007bff;
            color: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .ribbon-bar.download {
            background-color: #28a745; /* Green for download ribbon */
        }
        .ribbon-bar.download:hover {
            background-color: #218838; /* Darker green on hover */
        }
        .ribbon-bar h2 {
            color: white;
            margin: 0;
        }
        .ribbon-bar .arrow {
            font-size: 1.5em;
            transition: transform 0.3s ease;
        }
        .ribbon-bar.expanded .arrow {
            transform: rotate(90deg);
        }
        .explanation-content {
            display: none;
            padding: 15px;
            border: 1px solid #ddd;
            border-top: none;
            border-radius: 0 0 5px 5px;
            background-color: #f9f9f9;
            text-align: justify;
        }
        .explanation-content.show {
            display: block;
        }
        /* End Ribbon Bar Styling */

        .input-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
            width: 100%;
            box-sizing: border-box;
        }
        .input-line {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
        }
        .input-line label {
            flex-shrink: 0;
            width: 120px; /* Reduced width for better mobile fit */
            text-align: left;
            font-size: 0.9em;
        }
        .input-line input[type="text"],
        .input-line input[type="number"],
        .input-line input[type="date"],
        .input-line input[type="file"] {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            min-width: 100px; /* Ensure inputs don't shrink too much */
            box-sizing: border-box;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #0056b3;
        }
        .add-button {
            margin-top: 10px;
        }
        .entered-item {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            padding: 10px;
            border-radius: 3px;
            margin-bottom: 10px;
        }
        .action-button {
            padding: 5px 10px;
            margin-left: 5px;
            font-size: 0.8em;
        }
        .edit-button {
            background-color: #28a745;
        }
        .edit-button:hover {
            background-color: #218838;
        }
        .delete-button {
            background-color: #dc3545;
        }
        .delete-button:hover {
            background-color: #c82333;
        }
        #manual-inputs > div:not(:first-child),
        #nurses-input > div:not(:first-child),
        #requirements-input > div:not(:first-child),
        #preferences-input > div:not(:first-child) {
            margin-top: 10px;
            border-top: 1px dashed #eee;
            padding-top: 10px;
        }
        #gantt-chart {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #reports {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #reports a {
            display: block;
            margin-bottom: 5px;
            color: #007bff;
            text-decoration: none;
        }
        #reports a:hover {
            text-decoration: underline;
        }
        .note {
            color: #777;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
        }
        #status,
        #error-message {
            color: red;
            margin-top: 10px;
        }
        .upload-label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block;
        }
        #templates {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        #templates h2 {
            color: #333;
            margin-top: 0;
        }
        #templates a {
            display: block;
            margin-bottom: 5px;
            color: #007bff;
            text-decoration: none;
        }
        #templates a:hover {
            text-decoration: underline;
        }
        #gantt-placeholder {
            max-width: 100%;
            display: block;
            margin-top: 10px;
        }
        #gantt-caption, #reports-caption {
            color: #777;
            font-size: 0.9em;
            margin-top: 5px;
            display: block;
            text-align: center;
        }
        /* Ribbon Wrapper and Styling */
        .ribbon-wrapper {
            position: relative;
            min-width: 100px; /* Keep minimum width for smaller screens */
            max-width: 200px; /* Set a maximum width to prevent stretching */
            width: auto; /* Allow natural width based on content */
            box-sizing: border-box;
        }
        .ribbon {
            background-color: #808080; /* Grey to match file input buttons */
            color: white;
            padding: 8px;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
            font-size: 0.9em;
            transition: background-color 0.3s ease;
            width: 100%; /* Ensure ribbon takes full width of ribbon-wrapper */
            box-sizing: border-box;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* Truncates long file names with "..." */
        }
        .ribbon:hover {
            background-color: #6b6b6b; /* Darker grey for hover effect */
        }
        .date-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            box-sizing: border-box;
        }
        /* Ensure calendar icon is visible in supported browsers */
        .date-input::-webkit-calendar-picker-indicator {
            cursor: pointer;
        }
        /* Mobile-specific styles */
        @media (max-width: 600px) {
            .input-line {
                flex-direction: column; /* Stack inputs vertically */
                align-items: stretch;
            }
            .input-line label {
                width: 100%; /* Full width for labels */
                text-align: left;
                margin-bottom: 5px;
            }
            .input-line input[type="text"],
            .input-line input[type="number"],
            .input-line input[type="date"],
            .input-line input[type="file"] {
                width: 100%; /* Full width for inputs */
                min-width: 0;
            }
            .action-button {
                margin-top: 5px;
                width: auto; /* Ensure buttons don't stretch too wide */
            }
            .input-section {
                padding: 10px; /* Reduced padding for smaller screens */
            }
            body {
                margin: 10px; /* Reduced margin for mobile */
            }
            .ribbon-bar h2 {
                font-size: 1.2em; /* Smaller header on mobile */
            }
            .ribbon-wrapper {
                width: 100%;
                margin-bottom: 5px;
            }
            .ribbon {
                width: 100%;
            }
            .date-input {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>Helsa Nurse Scheduling Application</h1>

    <div class="ribbon-bar" onclick="toggleExplanation()">
        <b>General Information</b>
        <span class="arrow">►</span>
    </div>
    <div id="general-info-content" class="explanation-content">
        <p>Nurse scheduling (or shift management) is a long-standing challenge in many hospitals and healthcare systems. While the problem has been widely studied in academia, especially in operations research, there are still few software tools that are actually used by hospital staff.</p>
        <p>Based on our interviews with nurses from three different hospitals in Iran, we found that nurse scheduling is still often done manually by one of the volunteer nurses. This process can be time-consuming and inefficient, especially when considering multiple constraints such as department-specific shift requirements, and fairness (based on seniority, weekend and night shifts, and individual preferences). This problem is a variation of the classic "assignment problem" in operations research. To address this problem, we develop an integer programming model in Python using the Gurobi optimization library. More technical details are available in the application user manual.</p>
        <p>To generate the optimal nurse schedule, the following three sets of inputs are defined: 1. Nurses' ID/Name/Seniority. 2. Shift requirements (number of nurses needed per shift across the planning horizon). 3. Preferences of each nurse for each shift (if available). You can enter the inputs in one of two ways: File Upload and Manual Entry. You can also combine both methods, manual entries will override any matching entries from the uploaded files.</p>
        <p>In case of uploading input files, please use the format provided in the template files available on this page. Download the three input templates, complete them using your own nurse data and requirements, and make sure to keep the header rows and file names unchanged. Upload the completed files and then click "Generate Schedule and Reports".</p>
        <p>You can also download sample output files (generated based on the template inputs) to understand the expected format and compare them with your own results. These sample outputs are provided in the Reports section below and will be replaced with new output files based on your uploaded inputs after generating the schedule.</p>
    </div>

    <div class="ribbon-bar download" onclick="downloadUserManual()">
        <b>User Manual</b>
        <span class="arrow">⤵</span>
    </div>

    <div id="templates" class="input-section">
        <h2>Download Templates</h2>
        <a href="templates/nurses_file.csv" download="nurses_file.csv">Download Nurses Template (CSV)</a>
        <a href="templates/requirements_file.csv" download="requirements_file.csv">Download Requirements Template (CSV)</a>
        <a href="templates/preferences_file.csv" download="preferences_file.csv">Download Preferences Template (CSV)</a>
    </div>

    <div class="input-section">
        <h2>File Upload</h2>
        <p class="note">Leave blank if using manual input.</p>
        <label for="nursesFile" class="upload-label">Upload Nurses Data (CSV):</label>
        <div class="ribbon-wrapper">
            <div class="ribbon" onclick="triggerFileInput('nursesFile')">Choose File</div>
            <input type="file" id="nursesFile" accept=".csv" style="display: none;">
        </div>
        <label for="requirementsFile" class="upload-label">Upload Requirements Data (CSV):</label>
        <div class="ribbon-wrapper">
            <div class="ribbon" onclick="triggerFileInput('requirementsFile')">Choose File</div>
            <input type="file" id="requirementsFile" accept=".csv" style="display: none;">
        </div>
        <label for="preferencesFile" class="upload-label">Upload Preferences Data (CSV):</label>
        <div class="ribbon-wrapper">
            <div class="ribbon" onclick="triggerFileInput('preferencesFile')">Choose File</div>
            <input type="file" id="preferencesFile" accept=".csv" style="display: none;">
        </div>
    </div>

    <div class="input-section">
        <h2>Manual Input</h2>
        <div id="manual-inputs">
            <div id="nurses-input">
                <h3>Nurses Information</h3>
                <p class="note">Enter nurse ID, Name, and Type (1 for normal, 2 for senior).</p>
                <div class="input-line">
                    <label>Nurse Info:</label>
                    <input type="text" placeholder="ID" data-input-type="nurse_id">
                    <input type="text" placeholder="Name" data-input-type="nurse_name">
                    <input type="number" placeholder="Type (1/2)" data-input-type="nurse_type" min="1" max="2">
                </div>
                <button type="button" class="add-button" onclick="addNurseInput()">Add Nurse</button>
            </div>

            <div id="requirements-input">
                <h3>Shift Requirements</h3>
                <p class="note">Specify start date, end date, shift (1: Morning, 2: Evening, 3: Night), nurse type (1 for normal, 2 for senior), minimum and maximum required nurses. To define single-day requirements, please set the start and end dates to the same day.</p>
                <div class="input-line">
                    <label>Requirement:</label>
                    <div class="ribbon-wrapper">
                        <div class="ribbon" onclick="toggleDateInput(this)">Enter Start Date</div>
                        <input type="date" data-input-type="req_start_date" class="date-input" style="display: none;">
                    </div>
                    <div class="ribbon-wrapper">
                        <div class="ribbon" onclick="toggleDateInput(this)">Enter End Date</div>
                        <input type="date" data-input-type="req_end_date" class="date-input" style="display: none;">
                    </div>
                    <input type="number" placeholder="Shift (1/2/3)" data-input-type="req_shift" min="1" max="3">
                    <input type="number" placeholder="Nurse Type (1/2)" data-input-type="req_nurse_type" min="1" max="2">
                    <input type="number" placeholder="Min Req" data-input-type="req_min" min="0">
                    <input type="number" placeholder="Max Req" data-input-type="req_max" min="0">
                </div>
                <button type="button" class="add-button" onclick="addRequirementInput()">Add Requirement</button>
            </div>

            <div id="preferences-input">
                <h3>Preferences</h3>
                <p class="note">Enter nurse ID, date, shift (1: Morning, 2: Evening, 3: Night), and preference level (0–10). A preference level of 0 means unavailable; 1–10 indicates preference (10 is most preferred).</p>
                <div class="input-line">
                    <label>Preference:</label>
                    <input type="text" placeholder="Nurse ID" data-input-type="pref_nurse_id">
                    <div class="ribbon-wrapper">
                        <div class="ribbon" onclick="toggleDateInput(this)">Enter Date</div>
                        <input type="date" data-input-type="pref_date" class="date-input" style="display: none;">
                    </div>
                    <input type="number" placeholder="Shift (1/2/3)" data-input-type="pref_shift" min="1" max="3">
                    <input type="number" placeholder="Preference Level (0-10)" data-input-type="pref_level" min="0" max="10">
                </div>
                <button type="button" class="add-button" onclick="addPreferenceInput()">Add Preference</button>
            </div>
        </div>
    </div>

    <button type="button" onclick="generateSchedule()">Generate Schedule and Reports</button>
    <div id="status"></div>

    <div id="reports">
        <h2>Reports</h2>
        <p id="reports-caption">The below reports are sample outputs based on template inputs. The optimal reports based on your inputs will be available here after generating the new schedule.</p>
        <a id="schedule-placeholder" href="templates/placeholder_schedule.csv" download="placeholder_schedule.csv">Download Sample Optimal Schedule (CSV)</a>
        <a id="stats-placeholder" href="templates/placeholder_stats.csv" download="placeholder_stats.csv">Download Sample Nurse Statistics (CSV)</a>
        <a id="coverage-placeholder" href="templates/placeholder_coverage.csv" download="placeholder_coverage.csv">Download Sample Shift Coverage (CSV)</a>
        <a id="pdf-placeholder" href="templates/placeholder_report.pdf" download="placeholder_report.pdf">Download Sample Nurse Report (PDF)</a>
        <a id="gantt-placeholder-link" href="templates/placeholder_gantt.png" download="placeholder_gantt.png">Download Sample Gantt Chart (PNG)</a>
        <a id="schedule-csv" href="#" style="display: none;">Download Optimal Schedule (CSV)</a>
        <a id="stats-csv" href="#" style="display: none;">Download Nurse Statistics (CSV)</a>
        <a id="coverage-csv" href="#" style="display: none;">Download Shift Coverage (CSV)</a>
        <a id="pdf-report" href="#" style="display: none;">Download Nurse Report (PDF)</a>
        <a id="gantt-png" href="#" style="display: none;">Download Gantt Chart (PNG)</a>
    </div>

    <div id="gantt-chart">
        <h2>Gantt Chart</h2>
        <p class="note"></p>
        <span id="gantt-caption" style="display:block; text-align:center; color:#777; font-size:0.9em; margin-top:5px;">The below Gantt chart is based on template inputs. The optimal Gantt chart based on your inputs will be displayed here after generating the new schedule.</span>
        <img id="gantt-placeholder" src="templates/placeholder_gantt.png" alt="Gantt Chart Placeholder">
        <img id="gantt-image" style="max-width: 100%; display: none;" alt="Gantt Chart">
    </div>

    <script>
    function toggleExplanation() {
        const content = document.getElementById('general-info-content');
        const ribbon = document.querySelector('.ribbon-bar');
        content.classList.toggle('show');
        ribbon.classList.toggle('expanded');
    }

    // Function to trigger user manual download
    async function downloadUserManual() {
        const url = 'templates/user_manual.pdf';
        const filename = 'user_manual.pdf';
        try {
            await triggerDownload(url, filename);
            document.getElementById('status').innerText = 'User Manual download started.';
        } catch (error) {
            document.getElementById('status').innerText = 'Error downloading User Manual: ' + error.message;
        }
    }

    // Toggle date input visibility
    function toggleDateInput(ribbon) {
        const wrapper = ribbon.parentElement;
        const input = wrapper.querySelector('.date-input');
        ribbon.style.display = input.style.display === 'none' ? 'none' : 'block';
        input.style.display = input.style.display === 'none' ? 'block' : 'none';
        if (input.style.display === 'block') {
            input.focus();
        }
    }

    // Validation
    function validateInputs(inputs, includeDate = false) {
        for (let input of inputs) {
            if (input.type === 'date' && !includeDate) continue;
            if (!input.value && input.type !== 'file') return `Field ${input.placeholder || input.dataset.inputType} is empty.`;
            if (input.type === 'number') {
                const value = parseFloat(input.value);
                const min = parseFloat(input.min);
                const max = parseFloat(input.max);
                if (isNaN(value) || (input.min && value < min) || (input.max && value > max)) {
                    return `Field ${input.placeholder} must be between ${input.min} and ${input.max}.`;
                }
            }
        }
        return null;
    }

    // Add nurse input
    function addNurseInput() {
        const nursesInput = document.getElementById('nurses-input');
        const inputs = nursesInput.querySelector('.input-line:not(.entered-item)').querySelectorAll('input');
        const error = validateInputs(inputs);
        if (error) {
            alert(error);
            return;
        }
        const newInputLine = document.createElement('div');
        newInputLine.classList.add('input-line', 'entered-item');
        newInputLine.innerHTML = `
            <label>Nurse Info:</label>
            <input type="text" placeholder="ID" data-input-type="nurse_id" readonly>
            <input type="text" placeholder="Name" data-input-type="nurse_name" readonly>
            <input type="number" placeholder="Type (1/2)" data-input-type="nurse_type" min="1" max="2" readonly>
            <button type="button" class="action-button edit-button" onclick="editInput(this)">Edit</button>
            <button type="button" class="action-button delete-button" onclick="deleteInput(this)">Delete</button>
        `;
        nursesInput.appendChild(newInputLine);
        const newInputs = newInputLine.querySelectorAll('input');
        newInputs.forEach((input, i) => input.value = inputs[i].value);
        inputs.forEach(input => input.value = '');
    }

    // Add requirement input
    function addRequirementInput() {
        const requirementsInput = document.getElementById('requirements-input');
        const inputs = requirementsInput.querySelector('.input-line:not(.entered-item)').querySelectorAll('input');
        const error = validateInputs(inputs, true);
        if (error) {
            alert(error);
            return;
        }
        const startDate = new Date(inputs[0].value);
        const endDate = new Date(inputs[1].value);
        if (isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
            alert('Please enter valid dates for Start Date and End Date.');
            return;
        }
        if (startDate > endDate) {
            alert('End Date must be on or after Start Date.');
            return;
        }
        const newInputLine = document.createElement('div');
        newInputLine.classList.add('input-line', 'entered-item');
        newInputLine.innerHTML = `
            <label>Requirement:</label>
            <div class="ribbon-wrapper">
                <div class="ribbon" onclick="toggleDateInput(this)">${formatDateToMMDDYYYY(inputs[0].value)}</div>
                <input type="date" data-input-type="req_start_date" class="date-input" style="display: none;" readonly>
            </div>
            <div class="ribbon-wrapper">
                <div class="ribbon" onclick="toggleDateInput(this)">${formatDateToMMDDYYYY(inputs[1].value)}</div>
                <input type="date" data-input-type="req_end_date" class="date-input" style="display: none;" readonly>
            </div>
            <input type="number" placeholder="Shift (1/2/3)" data-input-type="req_shift" min="1" max="3" readonly>
            <input type="number" placeholder="Nurse Type (1/2)" data-input-type="req_nurse_type" min="1" max="2" readonly>
            <input type="number" placeholder="Min Req" data-input-type="req_min" min="0" readonly>
            <input type="number" placeholder="Max Req" data-input-type="req_max" min="0" readonly>
            <button type="button" class="action-button edit-button" onclick="editInput(this)">Edit</button>
            <button type="button" class="action-button delete-button" onclick="deleteInput(this)">Delete</button>
        `;
        requirementsInput.appendChild(newInputLine);
        const newInputs = newInputLine.querySelectorAll('input');
        newInputs[0].value = inputs[0].value; // Start Date
        newInputs[1].value = inputs[1].value; // End Date
        newInputs[2].value = inputs[2].value; // Shift
        newInputs[3].value = inputs[3].value; // Nurse Type
        newInputs[4].value = inputs[4].value; // Min Req
        newInputs[5].value = inputs[5].value; // Max Req
        inputs.forEach(input => input.value = '');
        // Reset ribbons to visible and hide date inputs
        const wrappers = requirementsInput.querySelector('.input-line:not(.entered-item)').querySelectorAll('.ribbon-wrapper');
        wrappers.forEach(wrapper => {
            wrapper.querySelector('.ribbon').style.display = 'block';
            wrapper.querySelector('.ribbon').textContent = wrapper.querySelector('.date-input').dataset.inputType.includes('start') ? 'Enter Start Date' : 'Enter End Date';
            wrapper.querySelector('.date-input').style.display = 'none';
        });
    }

    // Add preference input
    function addPreferenceInput() {
        const preferencesInput = document.getElementById('preferences-input');
        const inputs = preferencesInput.querySelector('.input-line:not(.entered-item)').querySelectorAll('input');
        const error = validateInputs(inputs, true);
        if (error) {
            alert(error);
            return;
        }
        const newInputLine = document.createElement('div');
        newInputLine.classList.add('input-line', 'entered-item');
        newInputLine.innerHTML = `
            <label>Preference:</label>
            <input type="text" placeholder="Nurse ID" data-input-type="pref_nurse_id" readonly>
            <div class="ribbon-wrapper">
                <div class="ribbon" onclick="toggleDateInput(this)">${formatDateToMMDDYYYY(inputs[1].value)}</div>
                <input type="date" data-input-type="pref_date" class="date-input" style="display: none;" readonly>
            </div>
            <input type="number" placeholder="Shift (1/2/3)" data-input-type="pref_shift" min="1" max="3" readonly>
            <input type="number" placeholder="Preference Level (0-10)" data-input-type="pref_level" min="0" max="10" readonly>
            <button type="button" class="action-button edit-button" onclick="editInput(this)">Edit</button>
            <button type="button" class="action-button delete-button" onclick="deleteInput(this)">Delete</button>
        `;
        preferencesInput.appendChild(newInputLine);
        const newInputs = newInputLine.querySelectorAll('input');
        newInputs[0].value = inputs[0].value; // Nurse ID
        newInputs[1].value = inputs[1].value; // Date
        newInputs[2].value = inputs[2].value; // Shift
        newInputs[3].value = inputs[3].value; // Preference Level
        inputs.forEach(input => input.value = '');
        // Reset ribbon to visible and hide date input
        const wrapper = preferencesInput.querySelector('.input-line:not(.entered-item)').querySelector('.ribbon-wrapper');
        wrapper.querySelector('.ribbon').style.display = 'block';
        wrapper.querySelector('.ribbon').textContent = 'Enter Date';
        wrapper.querySelector('.date-input').style.display = 'none';
    }

    // Edit input
    function editInput(button) {
        const inputLine = button.parentElement;
        const inputs = inputLine.querySelectorAll('input');
        inputs.forEach(input => input.removeAttribute('readonly'));
        // Show date inputs and hide ribbons when editing
        inputLine.querySelectorAll('.ribbon-wrapper').forEach(wrapper => {
            wrapper.querySelector('.ribbon').style.display = 'none';
            wrapper.querySelector('.date-input').style.display = 'block';
        });
        button.textContent = 'Save';
        button.onclick = () => saveInput(button);
    }

    // Save input
    function saveInput(button) {
        const inputLine = button.parentElement;
        const inputs = inputLine.querySelectorAll('input');
        const error = validateInputs(inputs, true);
        if (error) {
            alert(error);
            return;
        }
        if (inputs[0].dataset.inputType === 'req_start_date') {
            const startDate = new Date(inputs[0].value);
            const endDate = new Date(inputs[1].value);
            if (isNaN(startDate)) {
                alert("Invalid start date entered");
                return;
            }
            if (isNaN(endDate)) {
                alert("Invalid end date entered");
                return;
            }
            if (startDate > endDate) {
                alert('End Date must be on or after Start Date.');
                return;
            }
        }
        inputs.forEach(input => input.setAttribute('readonly', ''));
        // Show ribbons and update their text with selected dates
        inputLine.querySelectorAll('.ribbon-wrapper').forEach(wrapper => {
            const dateInput = wrapper.querySelector('.date-input');
            wrapper.querySelector('.ribbon').textContent = dateInput.value ? formatDateToMMDDYYYY(dateInput.value) : (dateInput.dataset.inputType.includes('start') ? 'start_date' : 'end_date');
            wrapper.querySelector('.ribbon').style.display = 'block';
            wrapper.querySelector('.date-input').style.display = 'none';
        });
        button.textContent = 'Edit';
        button.onclick = () => editInput(button);
    }

    // Delete input
    function deleteInput(button) {
        button.parentElement.remove();
    }

    // Helper function to convert ISO-8601 date (YYYY-MM-DD) to MM/DD/YYYY
    function formatDateToMMDDYYYY(dateStr) {
        if (!dateStr) return '';
        const [year, month, day] = dateStr.split('-');
        return `${month}/${day}/${year}`;
    }

    // Convert manual inputs to CSV format
    function manualToCSV() {
        const nurses = [];
        const requirements = [];
        const preferences = [];

        // Nurses data
        document.querySelectorAll('#nurses-input .entered-item').forEach(line => {
            const inputs = line.querySelectorAll('input');
            nurses.push(`${inputs[0].value},${inputs[1].value},${inputs[2].value}`);
        });

        // Shift requirements data
        document.querySelectorAll('#requirements-input .entered-item').forEach(line => {
            const inputs = line.querySelectorAll('input');
            const startDate = formatDateToMMDDYYYY(inputs[0].value);
            const endDate = formatDateToMMDDYYYY(inputs[1].value);
            requirements.push(`${startDate},${endDate},${inputs[2].value},${inputs[3].value},${inputs[4].value},${inputs[5].value}`);
        });

        // Preferences data
        document.querySelectorAll('#preferences-input .entered-item').forEach(line => {
            const inputs = line.querySelectorAll('input');
            const date = formatDateToMMDDYYYY(inputs[1].value);
            preferences.push(`${inputs[0].value},${date},${inputs[2].value},${inputs[3].value}`);
        });

        return {
            nurses: nurses.length ? 'ID,name,type\n' + nurses.join('\n') : '',
            requirements: requirements.length ? 'start_date,end_date,shift_id,nurse_type,min_req,max_req\n' + requirements.join('\n') : '',
            preferences: preferences.length ? 'nurse_id,date,shift_id,preference\n' + preferences.join('\n') : ''
        };
    }

    // Merge data from uploaded files and manual inputs
    async function mergeInputs(nursesFile, preferencesFile, requirementsFile) {
        const manual = manualToCSV();
        const result = { nurses: [], preferences: [], requirements: [] };

        // Function to read the content of a file
        const readFile = (file) => new Promise((resolve) => {
            if (!file) return resolve('');
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result.trim());
            reader.readAsText(file);
        });

        const [nursesFileContent, preferencesFileContent, requirementsFileContent] = await Promise.all([
            readFile(nursesFile),
            readFile(preferencesFile),
            readFile(requirementsFile)
        ]);

        // Process nurses data
        if (nursesFileContent) {
            result.nurses = nursesFileContent.split('\n').slice(1).filter(line => line.trim());
        }
        if (manual.nurses) {
            const manualNurses = manual.nurses.split('\n').slice(1).filter(line => line.trim());
            const nurseIds = new Set(result.nurses.map(line => line.split(',')[0]));
            manualNurses.forEach(line => {
                const id = line.split(',')[0];
                if (!nurseIds.has(id)) {
                    result.nurses.push(line);
                    nurseIds.add(id);
                } else {
                    const index = result.nurses.findIndex(l => l.startsWith(id + ','));
                    if (index !== -1) result.nurses[index] = line;
                    else result.nurses.push(line);
                }
            });
        }

        // Process preferences data
        if (preferencesFileContent) {
            result.preferences = preferencesFileContent.split('\n').slice(1).filter(line => line.trim());
        }
        if (manual.preferences) {
            const manualPrefs = manual.preferences.split('\n').slice(1).filter(line => line.trim());
            const prefKeys = new Set(result.preferences.map(line => line.split(',').slice(0, 3).join(',')));
            manualPrefs.forEach(line => {
                const key = line.split(',').slice(0, 3).join(',');
                if (!prefKeys.has(key)) {
                    result.preferences.push(line);
                    prefKeys.add(key);
                } else {
                    const index = result.preferences.findIndex(l => l.startsWith(key + ','));
                    if (index !== -1) result.preferences[index] = line;
                    else result.preferences.push(line);
                }
            });
        }

        // Process shift requirements data
        if (requirementsFileContent) {
            result.requirements = requirementsFileContent.split('\n').slice(1).filter(line => line.trim());
        }
        if (manual.requirements) {
            const manualReqs = manual.requirements.split('\n').slice(1).filter(line => line.trim());
            const reqKeys = new Set(result.requirements.map(line => line.split(',').slice(0, 4).join(',')));
            manualReqs.forEach(line => {
                const key = line.split(',').slice(0, 4).join(',');
                if (!reqKeys.has(key)) {
                    result.requirements.push(line);
                    reqKeys.add(key);
                } else {
                    const index = result.requirements.findIndex(l => l.startsWith(key + ','));
                    if (index !== -1) result.requirements[index] = line;
                    else result.requirements.push(line);
                }
            });
        }

        // Convert the merged data back to CSV strings
        return {
            nurses: result.nurses.length ? 'ID,name,type\n' + result.nurses.join('\n') : '',
            preferences: result.preferences.length ? 'nurse_id,date,shift_id,preference\n' + result.preferences.join('\n') : '',
            requirements: result.requirements.length ? 'start_date,end_date,shift_id,nurse_type,min_req,max_req\n' + result.requirements.join('\n') : ''
        };
    }

    // Helper function to trigger file download
    async function triggerDownload(url, filename) {
        try {
            const response = await fetch(url);
            const blob = await response.blob();
            const blobUrl = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = blobUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(blobUrl);
        } catch (error) {
            console.error('Download failed:', error);
            document.getElementById('status').innerText = 'Error downloading file: ' + error.message;
        }
    }

    // Function to initiate the schedule generation process
    async function generateSchedule() {
        // Retrieve the latest file inputs
        const nursesFile = document.getElementById('nursesFile').files[0];
        const preferencesFile = document.getElementById('preferencesFile').files[0];
        const requirementsFile = document.getElementById('requirementsFile').files[0];

        // Check if at least one input source (file or manual) has data
        const manualData = manualToCSV();
        const hasFileInput = nursesFile || preferencesFile || requirementsFile;
        const hasManualInput = manualData.nurses || manualData.preferences || manualData.requirements;

        if (!hasFileInput && !hasManualInput) {
            document.getElementById('status').innerText = 'Please provide at least one input (file or manual).';
            return;
        }

        document.getElementById('status').innerText = 'Processing inputs and running optimization...';
        // Reset Gantt chart
        document.getElementById('gantt-placeholder').style.display = 'block';
        document.getElementById('gantt-image').style.display = 'none';
        document.getElementById('gantt-caption').innerText = 'The below Gantt chart is based on template inputs.';
        // Reset Reports section
        document.getElementById('schedule-placeholder').style.display = 'block';
        document.getElementById('stats-placeholder').style.display = 'block';
        document.getElementById('coverage-placeholder').style.display = 'block';
        document.getElementById('pdf-placeholder').style.display = 'block';
        document.getElementById('gantt-placeholder-link').style.display = 'block';
        document.getElementById('schedule-csv').style.display = 'none';
        document.getElementById('stats-csv').style.display = 'none';
        document.getElementById('coverage-csv').style.display = 'none';
        document.getElementById('pdf-report').style.display = 'none';
        document.getElementById('gantt-png').style.display = 'none';
        document.getElementById('reports-caption').innerText = 'The below reports are sample outputs based on template inputs. The optimal reports based on your inputs will be available here after generating the new schedule.';

        try {
            // Always merge the latest inputs
            const mergedData = await mergeInputs(nursesFile, preferencesFile, requirementsFile);

            // Basic validation to ensure all data types are present
            if (!mergedData.nurses || !mergedData.preferences || !mergedData.requirements) {
                document.getElementById('status').innerText = 'Incomplete input data. Please provide all required data.';
                return;
            }

            // Prepare the form data to send to the backend
            const formData = new FormData();
            formData.append('nurses_file', new Blob([mergedData.nurses], { type: 'text/csv' }), 'nurses.csv');
            formData.append('preferences_file', new Blob([mergedData.preferences], { type: 'text/csv' }), 'preferences.csv');
            formData.append('requirements_file', new Blob([mergedData.requirements], { type: 'text/csv' }), 'requirements.csv');

            // Send the data to the backend for optimization
            const response = await fetch('https://hamedmilani.pythonanywhere.com/upload_and_run', {
                method: 'POST',
                body: formData,
            });

            const result = await response.json();
            document.getElementById('status').innerText = result.response || result.error || 'An error occurred during processing.';

            // If the optimization was successful, display the results
            if (result.response && result.response.startsWith('Optimization successful')) {
                const outputBaseURL = 'https://hamedmilani.pythonanywhere.com/get_output/';
                // Update Gantt chart
                document.getElementById('gantt-image').src = outputBaseURL + 'schedule_gantt.png?' + new Date().getTime();
                document.getElementById('gantt-placeholder').style.display = 'none';
                document.getElementById('gantt-image').style.display = 'block';
                document.getElementById('gantt-caption').innerText = 'The below Gantt chart visualizing the optimal nurse schedule is based on your inputs.';
                // Update Reports section
                document.getElementById('schedule-csv').href = outputBaseURL + 'optimal_schedule.csv?' + new Date().getTime();
                document.getElementById('stats-csv').href = outputBaseURL + 'nurse_stats.csv?' + new Date().getTime();
                document.getElementById('coverage-csv').href = outputBaseURL + 'shift_coverage.csv?' + new Date().getTime();
                // Set up click handlers for PDF and PNG to trigger downloads
                const pdfLink = document.getElementById('pdf-report');
                const ganttLink = document.getElementById('gantt-png');
                pdfLink.href = '#'; // Prevent default navigation
                ganttLink.href = '#'; // Prevent default navigation
                pdfLink.onclick = (e) => {
                    e.preventDefault();
                    triggerDownload(outputBaseURL + 'combined_nurse_reports.pdf?' + new Date().getTime(), 'combined_nurse_reports.pdf');
                };
                ganttLink.onclick = (e) => {
                    e.preventDefault();
                    triggerDownload(outputBaseURL + 'schedule_gantt.png?' + new Date().getTime(), 'schedule_gantt.png');
                };
                document.getElementById('schedule-placeholder').style.display = 'none';
                document.getElementById('stats-placeholder').style.display = 'none';
                document.getElementById('coverage-placeholder').style.display = 'none';
                document.getElementById('pdf-placeholder').style.display = 'none';
                document.getElementById('gantt-placeholder-link').style.display = 'none';
                document.getElementById('schedule-csv').style.display = 'block';
                document.getElementById('stats-csv').style.display = 'block';
                document.getElementById('coverage-csv').style.display = 'block';
                document.getElementById('pdf-report').style.display = 'block';
                document.getElementById('gantt-png').style.display = 'block';
                document.getElementById('reports-caption').innerText = 'The below reports contain the optimal nurse schedule and statistics based on your inputs.';
            }
        } catch (error) {
            document.getElementById('status').innerText = 'Error: ' + error.message;
        }
    }

    function triggerFileInput(inputId) {
        const fileInput = document.getElementById(inputId);
        fileInput.click();
    }

    // Update ribbon text for file inputs
    document.querySelectorAll('input[type="file"]').forEach(input => {
        input.addEventListener('change', function() {
            const ribbon = this.parentElement.querySelector('.ribbon');
            ribbon.textContent = this.files.length > 0 ? this.files[0].name : 'Choose File';
        });
    });

    // Update ribbon text when a date is selected
    document.querySelectorAll('.date-input').forEach(input => {
        input.addEventListener('change', function() {
            const ribbon = this.parentElement.querySelector('.ribbon');
            ribbon.textContent = this.value ? formatDateToMMDDYYYY(this.value) : (this.dataset.inputType.includes('start') ? 'Enter Start Date' : this.dataset.inputType.includes('end') ? 'Enter End Date' : 'Enter Date');
        });
    });
</script>
</body>
</html>
