<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HELSA Nurse Scheduling with Pyodide</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: #333;
            max-width: 1200px;
            margin: 0 auto;
        }
        h1, h2 {
            color: #2c3e50;
        }
        .section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .input-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .input-row {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        .input-row label {
            min-width: 120px;
            font-weight: bold;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex-grow: 1;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button.secondary {
            background-color: #95a5a6;
        }
        button.secondary:hover {
            background-color: #7f8c8d;
        }
        button.danger {
            background-color: #e74c3c;
        }
        button.danger:hover {
            background-color: #c0392b;
        }
        #loading {
            display: none;
            margin: 20px 0;
            padding: 15px;
            background-color: #f39c12;
            color: white;
            border-radius: 4px;
            text-align: center;
        }
        #results {
            display: none;
            margin-top: 20px;
        }
        .item-list {
            margin-top: 15px;
            border-top: 1px solid #ddd;
            padding-top: 15px;
        }
        .item {
            background-color: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-left: 4px solid #3498db;
        }
        .item-actions {
            display: flex;
            gap: 5px;
        }
        #gantt-container {
            margin-top: 20px;
            text-align: center;
        }
        #gantt-image {
            max-width: 100%;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .download-link {
            display: inline-block;
            margin-right: 15px;
            color: #3498db;
            text-decoration: none;
            padding: 5px 10px;
            border: 1px solid #3498db;
            border-radius: 4px;
        }
        .download-link:hover {
            background-color: #f0f8ff;
        }
        .note {
            font-size: 0.9em;
            color: #7f8c8d;
            margin-top: 5px;
        }
        .error {
            color: #e74c3c;
            background-color: #fadbd8;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            display: none;
        }
    </style>
</head>
<body>
    <h1>HELSA Nurse Scheduling</h1>
    <p>This tool helps optimize nurse schedules based on shift requirements and nurse preferences.</p>
    
    <div class="error" id="error-message"></div>
    
    <div class="section">
        <h2>Shift Definitions</h2>
        <div class="input-group">
            <p>The following shifts are predefined in the system:</p>
            <ul>
                <li><strong>Morning</strong> (ID: 1): 8 hours</li>
                <li><strong>Evening</strong> (ID: 2): 8 hours</li>
                <li><strong>Night</strong> (ID: 3): 10 hours</li>
            </ul>
            <p class="note">Note: Preference level 0 means the nurse is unavailable for that shift on that day.</p>
        </div>
    </div>
    
    <div class="section" id="nurses-section">
        <h2>Nurses</h2>
        <div class="input-group">
            <div class="input-row">
                <label for="nurse-id">Nurse ID:</label>
                <input type="text" id="nurse-id" placeholder="Unique identifier">
            </div>
            <div class="input-row">
                <label for="nurse-name">Name:</label>
                <input type="text" id="nurse-name" placeholder="Nurse's full name">
            </div>
            <div class="input-row">
                <label for="nurse-type">Type:</label>
                <select id="nurse-type">
                    <option value="0">Regular Nurse</option>
                    <option value="1">Senior Nurse</option>
                </select>
            </div>
            <button id="add-nurse">Add Nurse</button>
            
            <div class="item-list" id="nurses-list"></div>
        </div>
    </div>
    
    <div class="section" id="requirements-section">
        <h2>Shift Requirements</h2>
        <div class="input-group">
            <div class="input-row">
                <label for="req-start-date">Start Date:</label>
                <input type="date" id="req-start-date">
            </div>
            <div class="input-row">
                <label for="req-end-date">End Date:</label>
                <input type="date" id="req-end-date">
            </div>
            <div class="input-row">
                <label for="req-shift">Shift:</label>
                <select id="req-shift">
                    <option value="1">Morning</option>
                    <option value="2">Evening</option>
                    <option value="3">Night</option>
                </select>
            </div>
            <div class="input-row">
                <label for="req-nurse-type">Nurse Type:</label>
                <select id="req-nurse-type">
                    <option value="0">All Nurses</option>
                    <option value="1">Senior Nurses Only</option>
                </select>
            </div>
            <div class="input-row">
                <label for="req-min">Minimum Nurses:</label>
                <input type="number" id="req-min" min="0" value="1">
            </div>
            <div class="input-row">
                <label for="req-max">Maximum Nurses:</label>
                <input type="number" id="req-max" min="1" value="3">
            </div>
            <button id="add-requirement">Add Requirement</button>
            
            <div class="item-list" id="requirements-list"></div>
        </div>
    </div>
    
    <div class="section" id="preferences-section">
        <h2>Nurse Preferences</h2>
        <div class="input-group">
            <div class="input-row">
                <label for="pref-nurse-id">Nurse ID:</label>
                <input type="text" id="pref-nurse-id" placeholder="Enter nurse ID">
            </div>
            <div class="input-row">
                <label for="pref-shift">Shift:</label>
                <select id="pref-shift">
                    <option value="1">Morning</option>
                    <option value="2">Evening</option>
                    <option value="3">Night</option>
                </select>
            </div>
            <div class="input-row">
                <label for="pref-date">Date:</label>
                <input type="date" id="pref-date">
            </div>
            <div class="input-row">
                <label for="pref-level">Preference Level (0=Unavailable):</label>
                <input type="number" id="pref-level" min="0" max="10" value="5">
            </div>
            <button id="add-preference">Add Preference</button>
            
            <div class="item-list" id="preferences-list"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>Run Optimization</h2>
        <button id="run-optimization">Generate Optimal Schedule</button>
        <div id="loading">
            <p>Running optimization... This may take a few minutes.</p>
            <p>Please don't close the browser tab.</p>
        </div>
    </div>
    
    <div id="results">
        <div class="section">
            <h2>Results</h2>
            <div id="gantt-container">
                <h3>Schedule Gantt Chart</h3>
                <img id="gantt-image" src="" alt="Gantt Chart">
            </div>
            
            <div style="margin-top: 20px;">
                <h3>Download Reports</h3>
                <a href="#" class="download-link" id="download-schedule">Download Schedule (CSV)</a>
                <a href="#" class="download-link" id="download-stats">Download Nurse Statistics (CSV)</a>
                <a href="#" class="download-link" id="download-coverage">Download Shift Coverage (CSV)</a>
            </div>
        </div>
    </div>

    <script>
        // Data storage
        const data = {
            nurses: [],
            requirements: [],
            preferences: []
        };
        
        // Initialize Pyodide
        let pyodide;
        async function initializePyodide() {
            try {
                pyodide = await loadPyodide({
                    indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
                });
                
                // Load required packages
                await pyodide.loadPackage("micropip");
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install(['pandas', 'matplotlib'])
                `);
                
                console.log("Pyodide initialized successfully");
            } catch (error) {
                showError("Failed to initialize Pyodide: " + error.message);
            }
        }
        
        // Initialize the app when the page loads
        window.addEventListener('load', async function() {
            await initializePyodide();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Nurse form
            document.getElementById('add-nurse').addEventListener('click', addNurse);
            
            // Requirement form
            document.getElementById('add-requirement').addEventListener('click', addRequirement);
            
            // Preference form
            document.getElementById('add-preference').addEventListener('click', addPreference);
            
            // Run optimization button
            document.getElementById('run-optimization').addEventListener('click', runOptimization);
        }
        
        function addNurse() {
            const id = document.getElementById('nurse-id').value.trim();
            const name = document.getElementById('nurse-name').value.trim();
            const type = document.getElementById('nurse-type').value;
            
            if (!id || !name) {
                showError("Please enter both nurse ID and name");
                return;
            }
            
            // Check if nurse ID already exists
            if (data.nurses.some(n => n.ID === id)) {
                showError(`Nurse with ID ${id} already exists`);
                return;
            }
            
            const nurse = {
                ID: id,
                name: name,
                type: parseInt(type)
            };
            
            data.nurses.push(nurse);
            updateNursesList();
            
            // Clear form
            document.getElementById('nurse-id').value = '';
            document.getElementById('nurse-name').value = '';
        }
        
        function addRequirement() {
            const startDate = document.getElementById('req-start-date').value;
            const endDate = document.getElementById('req-end-date').value;
            const shift = document.getElementById('req-shift').value;
            const nurseType = document.getElementById('req-nurse-type').value;
            const min = document.getElementById('req-min').value;
            const max = document.getElementById('req-max').value;
            
            if (!startDate || !endDate) {
                showError("Please select both start and end dates");
                return;
            }
            
            if (new Date(endDate) < new Date(startDate)) {
                showError("End date must be after start date");
                return;
            }
            
            if (parseInt(min) > parseInt(max)) {
                showError("Minimum requirement cannot be greater than maximum");
                return;
            }
            
            const requirement = {
                start_date: startDate,
                end_date: endDate,
                shift_id: parseInt(shift),
                nurse_type: parseInt(nurseType),
                min_req: parseInt(min),
                max_req: parseInt(max)
            };
            
            data.requirements.push(requirement);
            updateRequirementsList();
        }
        
        function addPreference() {
            const nurseId = document.getElementById('pref-nurse-id').value.trim();
            const shift = document.getElementById('pref-shift').value;
            const date = document.getElementById('pref-date').value;
            const level = document.getElementById('pref-level').value;
            
            if (!nurseId || !date) {
                showError("Please enter nurse ID and select a date");
                return;
            }
            
            // Check if nurse exists
            if (!data.nurses.some(n => n.ID === nurseId)) {
                showError(`Nurse with ID ${nurseId} not found. Please add the nurse first.`);
                return;
            }
            
            const preference = {
                nurse_id: nurseId,
                shift_id: parseInt(shift),
                date: date,
                preference: parseInt(level)
            };
            
            data.preferences.push(preference);
            updatePreferencesList();
        }
        
        function updateNursesList() {
            const list = document.getElementById('nurses-list');
            list.innerHTML = '';
            
            if (data.nurses.length === 0) {
                list.innerHTML = '<p>No nurses added yet.</p>';
                return;
            }
            
            data.nurses.forEach((nurse, index) => {
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <div>
                        <strong>${nurse.name}</strong> (ID: ${nurse.ID}) - 
                        ${nurse.type === 1 ? 'Senior Nurse' : 'Regular Nurse'}
                    </div>
                    <div class="item-actions">
                        <button class="secondary" onclick="editNurse(${index})">Edit</button>
                        <button class="danger" onclick="deleteNurse(${index})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function updateRequirementsList() {
            const list = document.getElementById('requirements-list');
            list.innerHTML = '';
            
            if (data.requirements.length === 0) {
                list.innerHTML = '<p>No requirements added yet.</p>';
                return;
            }
            
            data.requirements.forEach((req, index) => {
                const shiftNames = {
                    1: 'Morning',
                    2: 'Evening',
                    3: 'Night'
                };
                
                const nurseType = req.nurse_type === 1 ? 'Senior Nurses' : 'All Nurses';
                
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <div>
                        ${req.start_date} to ${req.end_date}: ${shiftNames[req.shift_id]} (${nurseType}) - 
                        Min: ${req.min_req}, Max: ${req.max_req}
                    </div>
                    <div class="item-actions">
                        <button class="secondary" onclick="editRequirement(${index})">Edit</button>
                        <button class="danger" onclick="deleteRequirement(${index})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        function updatePreferencesList() {
            const list = document.getElementById('preferences-list');
            list.innerHTML = '';
            
            if (data.preferences.length === 0) {
                list.innerHTML = '<p>No preferences added yet.</p>';
                return;
            }
            
            data.preferences.forEach((pref, index) => {
                const shiftNames = {
                    1: 'Morning',
                    2: 'Evening',
                    3: 'Night'
                };
                
                const status = pref.preference === 0 ? 'Unavailable' : `Preference: ${pref.preference}`;
                
                const item = document.createElement('div');
                item.className = 'item';
                item.innerHTML = `
                    <div>
                        Nurse ${pref.nurse_id} on ${pref.date}: ${shiftNames[pref.shift_id]} - ${status}
                    </div>
                    <div class="item-actions">
                        <button class="secondary" onclick="editPreference(${index})">Edit</button>
                        <button class="danger" onclick="deletePreference(${index})">Delete</button>
                    </div>
                `;
                list.appendChild(item);
            });
        }
        
        // Edit functions
        function editNurse(index) {
            const nurse = data.nurses[index];
            document.getElementById('nurse-id').value = nurse.ID;
            document.getElementById('nurse-name').value = nurse.name;
            document.getElementById('nurse-type').value = nurse.type;
            
            // Remove the item from the array
            data.nurses.splice(index, 1);
            updateNursesList();
        }
        
        function editRequirement(index) {
            const req = data.requirements[index];
            document.getElementById('req-start-date').value = req.start_date;
            document.getElementById('req-end-date').value = req.end_date;
            document.getElementById('req-shift').value = req.shift_id;
            document.getElementById('req-nurse-type').value = req.nurse_type;
            document.getElementById('req-min').value = req.min_req;
            document.getElementById('req-max').value = req.max_req;
            
            // Remove the item from the array
            data.requirements.splice(index, 1);
            updateRequirementsList();
        }
        
        function editPreference(index) {
            const pref = data.preferences[index];
            document.getElementById('pref-nurse-id').value = pref.nurse_id;
            document.getElementById('pref-shift').value = pref.shift_id;
            document.getElementById('pref-date').value = pref.date;
            document.getElementById('pref-level').value = pref.preference;
            
            // Remove the item from the array
            data.preferences.splice(index, 1);
            updatePreferencesList();
        }
        
        // Delete functions
        function deleteNurse(index) {
            if (confirm("Are you sure you want to delete this nurse?")) {
                data.nurses.splice(index, 1);
                updateNursesList();
            }
        }
        
        function deleteRequirement(index) {
            if (confirm("Are you sure you want to delete this requirement?")) {
                data.requirements.splice(index, 1);
                updateRequirementsList();
            }
        }
        
        function deletePreference(index) {
            if (confirm("Are you sure you want to delete this preference?")) {
                data.preferences.splice(index, 1);
                updatePreferencesList();
            }
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            // Hide the error after 5 seconds
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        async function runOptimization() {
            if (data.nurses.length === 0) {
                showError("Please add at least one nurse");
                return;
            }
            
            if (data.requirements.length === 0) {
                showError("Please add at least one shift requirement");
                return;
            }
            
            // Show loading indicator
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                // Convert data to CSV strings
                const nursesCsv = toCsv(data.nurses, ['ID', 'name', 'type']);
                const prefsCsv = toCsv(data.preferences, ['nurse_id', 'shift_id', 'date', 'preference']);
                const reqsCsv = toCsv(data.requirements, ['start_date', 'end_date', 'shift_id', 'nurse_type', 'min_req', 'max_req']);
                
                // Prepare the Python code
                const pythonCode = `
import pandas as pd
import js
from io import StringIO
import base64
import matplotlib.pyplot as plt
from collections import defaultdict
from datetime import timedelta

# Get data from JavaScript
nurses_csv = js.nursesCsv
prefs_csv = js.prefsCsv
reqs_csv = js.reqsCsv

# Shift definitions
SHIFTS = {
    1: {"name": "Morning", "duration": 8, "color": "#4CAF50"},
    2: {"name": "Evening", "duration": 8, "color": "#FFC107"},
    3: {"name": "Night", "duration": 10, "color": "#F44336"}
}

# Load data
nurses_df = pd.read_csv(StringIO(nurses_csv))
prefs_df = pd.read_csv(StringIO(prefs_csv))
reqs_df = pd.read_csv(StringIO(reqs_csv))

# Convert date columns to datetime
prefs_df['date'] = pd.to_datetime(prefs_df['date'])
reqs_df['start_date'] = pd.to_datetime(reqs_df['start_date'])
reqs_df['end_date'] = pd.to_datetime(reqs_df['end_date'])

# Calculate date horizon
start_date = reqs_df["start_date"].min()
end_date = reqs_df["end_date"].max()
date_horizon = pd.date_range(start=start_date, end=end_date, freq='D').tolist()

# ==============================
# Optimization Model (simplified for Pyodide)
# ==============================
try:
    # We'll use a simpler optimization approach since Gurobi isn't available in Pyodide
    # This is a placeholder - in a real implementation you'd use a solver like GLPK or CBC
    
    # For demonstration, we'll create a dummy schedule that just shows the inputs
    schedule = []
    for nurse in nurses_df.to_dict('records'):
        for shift_id, shift in SHIFTS.items():
            for date in date_horizon:
                # Check if nurse is available (preference > 0)
                pref = prefs_df[
                    (prefs_df['nurse_id'] == nurse['ID']) & 
                    (prefs_df['shift_id'] == shift_id) & 
                    (prefs_df['date'] == date)
                ]['preference'].values
                
                if len(pref) > 0 and pref[0] == 0:
                    continue  # Nurse is unavailable
                
                # Check requirements
                req = reqs_df[
                    (reqs_df['start_date'] <= date) & 
                    (reqs_df['end_date'] >= date) & 
                    (reqs_df['shift_id'] == shift_id)
                ]
                
                if len(req) > 0:
                    schedule.append({
                        "nurse_id": nurse['ID'],
                        "nurse_name": nurse['name'],
                        "shift_id": shift_id,
                        "shift_name": shift['name'],
                        "date": date.strftime('%Y-%m-%d'),
                        "is_senior": nurse['type']
                    })
    
    schedule_df = pd.DataFrame(schedule)
    
    # Generate reports
    # Nurse statistics
    nurse_stats = []
    for nurse_id in schedule_df["nurse_id"].unique():
        nurse_data = schedule_df[schedule_df["nurse_id"] == nurse_id]
        stats = {
            "nurse_id": nurse_id,
            "nurse_name": nurse_data["nurse_name"].iloc[0],
            "total_shifts": len(nurse_data),
            "total_hours": sum(SHIFTS[s]["duration"] for s in nurse_data["shift_id"]),
            "is_senior": nurse_data["is_senior"].iloc[0]
        }
        for shift_id, shift in SHIFTS.items():
            stats[f"{shift['name']}_shifts"] = len(nurse_data[nurse_data["shift_id"] == shift_id])
        nurse_stats.append(stats)
    
    nurse_stats_df = pd.DataFrame(nurse_stats)
    
    # Shift coverage
    coverage = []
    for date_str in schedule_df["date"].unique():
        date_obj = pd.to_datetime(date_str).date()
        for shift_id, shift in SHIFTS.items():
            shift_data = schedule_df[
                (schedule_df["date"] == date_str) &
                (schedule_df["shift_id"] == shift_id)
            ]
            coverage.append({
                "date": date_obj.strftime('%Y-%m-%d'),
                "shift_id": shift_id,
                "shift_name": shift['name'],
                "total_nurses": len(shift_data),
                "senior_nurses": sum(shift_data["is_senior"])
            })
    
    coverage_df = pd.DataFrame(coverage)
    
    # Create Gantt chart
    fig, ax = plt.subplots(figsize=(15, 8))
    
    # Get unique nurses sorted by ID
    unique_nurses = schedule_df[['nurse_id', 'nurse_name']].drop_duplicates().sort_values('nurse_id')
    num_nurses = len(unique_nurses)
    num_dates = len(date_horizon)
    
    # Convert date horizon to numerical representation for plotting
    min_date = min(date_horizon).date()
    date_to_num = {date.date(): i for i, date in enumerate(date_horizon)}
    
    # Plot each nurse's schedule
    for idx, (nurse_id, nurse_name) in enumerate(zip(unique_nurses['nurse_id'], unique_nurses['nurse_name'])):
        nurse_schedule = schedule_df[schedule_df["nurse_id"] == nurse_id]
        for _, row in nurse_schedule.iterrows():
            start_num = date_to_num[pd.to_datetime(row["date"]).date()]
            rect = plt.Rectangle(
                (start_num - 0.5, idx - 0.4),
                1, 0.8,
                facecolor=SHIFTS[row["shift_id"]]["color"],
                edgecolor="black",
                alpha=0.7,
                hatch="////" if row["is_senior"] else None
            )
            ax.add_patch(rect)
            ax.text(
                start_num, idx,
                SHIFTS[row["shift_id"]]["name"][0],
                ha="center", va="center",
                fontweight="bold"
            )
    
    # Format axes
    ax.set_xlabel("Date")
    ax.set_ylabel("Nurse")
    ax.set_title("Nurse Schedule Gantt Chart")
    ax.set_xticks(range(num_dates))
    ax.set_xticklabels([d.strftime('%Y-%m-%d') for d in date_horizon], rotation=45, ha="right")
    ax.set_yticks(range(num_nurses))
    ax.set_yticklabels([
        f"{name} (ID: {id})"
        for id, name in zip(unique_nurses['nurse_id'], unique_nurses['nurse_name'])
    ])
    ax.grid(axis="x", linestyle="--", alpha=0.7)
    
    # Adjust y-axis limits to show the full rows
    ax.set_ylim(-0.5, num_nurses - 0.5)
    
    # Adjust x-axis limits to show the full first and last columns
    ax.set_xlim(-0.5, num_dates - 0.5)
    
    # Add legend
    legend_patches = [
        plt.Rectangle((0,0),1,1, color=shift["color"], label=shift["name"])
        for shift in SHIFTS.values()
    ]
    legend_patches.append(
        plt.Rectangle((0,0),1,1, facecolor="white", edgecolor="black", hatch="////", label="Senior Nurse")
    )
    ax.legend(handles=legend_patches, bbox_to_anchor=(1.05, 1), loc="upper left")
    
    plt.tight_layout()
    
    # Save the figure to a buffer
    from io import BytesIO
    buf = BytesIO()
    plt.savefig(buf, format='png', dpi=100)
    plt.close()
    buf.seek(0)
    
    # Convert to base64 for display in HTML
    image_base64 = base64.b64encode(buf.read()).decode('utf-8')
    
    # Convert DataFrames to CSV strings
    schedule_csv = schedule_df.to_csv(index=False)
    stats_csv = nurse_stats_df.to_csv(index=False)
    coverage_csv = coverage_df.to_csv(index=False)
    
    # Return results to JavaScript
    return {
        'success': True,
        'gantt_chart': image_base64,
        'schedule_csv': schedule_csv,
        'stats_csv': stats_csv,
        'coverage_csv': coverage_csv
    }

except Exception as e:
    return {
        'success': False,
        'error': str(e)
    }
                `;
                
                // Set the CSV data as JavaScript variables that Pyodide can access
                pyodide.globals.set('nursesCsv', nursesCsv);
                pyodide.globals.set('prefsCsv', prefsCsv);
                pyodide.globals.set('reqsCsv', reqsCsv);
                
                // Run the Python code
                const results = await pyodide.runPythonAsync(pythonCode);
                
                if (results.success) {
                    // Display the Gantt chart
                    document.getElementById('gantt-image').src = `data:image/png;base64,${results.gantt_chart}`;
                    
                    // Create download links
                    createDownloadLink('download-schedule', results.schedule_csv, 'optimal_schedule.csv');
                    createDownloadLink('download-stats', results.stats_csv, 'nurse_stats.csv');
                    createDownloadLink('download-coverage', results.coverage_csv, 'shift_coverage.csv');
                    
                    // Show results
                    document.getElementById('results').style.display = 'block';
                } else {
                    showError("Optimization failed: " + results.error);
                }
            } catch (error) {
                showError("Error during optimization: " + error.message);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        function toCsv(data, fields) {
            if (data.length === 0) return '';
            
            // Create header
            let csv = fields.join(',') + '\n';
            
            // Add rows
            data.forEach(item => {
                csv += fields.map(field => item[field]).join(',') + '\n';
            });
            
            return csv;
        }
        
        function createDownloadLink(elementId, csvData, fileName) {
            const element = document.getElementById(elementId);
            const blob = new Blob([csvData], { type: 'text/csv' });
            element.href = URL.createObjectURL(blob);
            element.download = fileName;
        }
    </script>
</body>
</html>
