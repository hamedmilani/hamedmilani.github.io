<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Minimal Chess</title>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/1.0.0/chess.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/chessboard.js/1.0.0/chessboard-1.0.0.min.css" rel="stylesheet"/>
  <style>
    body {
      background: #121212;
      color: #eee;
      font-family: sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }
    #board {
      max-width: 500px;
      margin: 20px auto;
    }
    #status, #timers, #controls {
      margin: 10px;
      text-align: center;
    }
    .highlight {
      background-color: rgba(0, 255, 0, 0.4) !important;
    }
    .check {
      background-color: orange !important;
    }
    .checkmate {
      background-color: red !important;
    }
    .clock {
      font-size: 1.2em;
      margin: 5px;
    }
    button {
      margin: 5px;
      padding: 8px 16px;
      background-color: #333;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      #board {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <h1>Minimal Chess</h1>
  <div id="board"></div>
  <div id="status">Game loading...</div>
  <div id="timers">
    <div class="clock" id="white-timer">White: 10:00</div>
    <div class="clock" id="black-timer">Black: 10:00</div>
  </div>
  <div id="controls">
    <button id="startBtn">Start Game</button>
    <button id="toggleTimerBtn">Toggle Timer</button>
    <button id="resetBtn">Reset</button>
  </div>

  <script>
    let board, game, timerActive = false;
    let whiteTime = 600, blackTime = 600, interval = null;
    let selectedSquare = null;

    const synth = new Tone.Synth().toDestination();

    function playSound(type) {
      if (type === 'move') synth.triggerAttackRelease("C4", "8n");
      else if (type === 'capture') synth.triggerAttackRelease("G4", "8n");
      else if (type === 'check') synth.triggerAttackRelease("E4", "8n");
      else if (type === 'mate') {
        synth.triggerAttackRelease("C4", "8n");
        setTimeout(() => synth.triggerAttackRelease("G4", "8n"), 200);
      }
    }

    function updateStatus() {
      let status = '';
      let moveColor = game.turn() === 'w' ? 'White' : 'Black';

      if (game.in_checkmate()) {
        status = `Checkmate! ${moveColor} loses.`;
        playSound('mate');
        stopTimer();
      } else if (game.in_draw()) {
        status = "Draw!";
        stopTimer();
      } else {
        status = `${moveColor} to move.`;
        if (game.in_check()) {
          status += ' Check!';
          playSound('check');
        }
      }
      $('#status').text(status);
      highlightKing();
    }

    function highlightKing() {
      board.removeGreySquares();
      let kingSquare = game.turn() === 'w' ? game.board().flat().find(p => p && p.type === 'k' && p.color === 'w') :
                                             game.board().flat().find(p => p && p.type === 'k' && p.color === 'b');
      if (!kingSquare) return;
      let square = game.SQUARES.find(sq => game.get(sq) && game.get(sq).type === 'k' && game.get(sq).color === game.turn());
      if (game.in_checkmate()) board.setSquareStyles({ [square]: { backgroundColor: 'red' } });
      else if (game.in_check()) board.setSquareStyles({ [square]: { backgroundColor: 'orange' } });
    }

    function updateTimers() {
      const format = t => {
        const m = String(Math.floor(t / 60)).padStart(2, '0');
        const s = String(t % 60).padStart(2, '0');
        return `${m}:${s}`;
      };
      $('#white-timer').text(`White: ${format(whiteTime)}`);
      $('#black-timer').text(`Black: ${format(blackTime)}`);
    }

    function startTimer() {
      if (interval) return;
      interval = setInterval(() => {
        if (!timerActive) return;
        if (game.turn() === 'w') whiteTime--;
        else blackTime--;

        if (whiteTime <= 0 || blackTime <= 0) {
          $('#status').text(`${whiteTime <= 0 ? 'White' : 'Black'} loses on time.`);
          stopTimer();
        }

        updateTimers();
      }, 1000);
    }

    function stopTimer() {
      clearInterval(interval);
      interval = null;
      timerActive = false;
    }

    function onDragStart(source, piece) {
      if (game.game_over()) return false;
      if ((game.turn() === 'w' && piece.startsWith('b')) ||
          (game.turn() === 'b' && piece.startsWith('w'))) return false;
    }

    function onDrop(source, target) {
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (!move) return 'snapback';

      playSound(move.captured ? 'capture' : 'move');
      updateStatus();
      startTimer();
    }

    function onSnapEnd() {
      board.position(game.fen());
    }

    function onSquareClick(square) {
      if (selectedSquare) {
        const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
        if (move) {
          playSound(move.captured ? 'capture' : 'move');
          board.position(game.fen());
          selectedSquare = null;
          board.removeGreySquares();
          updateStatus();
          return;
        }
      }

      const piece = game.get(square);
      if (!piece || piece.color !== game.turn()) {
        selectedSquare = null;
        board.removeGreySquares();
        return;
      }

      selectedSquare = square;
      board.removeGreySquares();
      const moves = game.moves({ square, verbose: true });
      const squares = {};
      moves.forEach(m => squares[m.to] = { backgroundColor: 'rgba(0,255,0,0.4)' });
      board.setSquareStyles(squares);
    }

    function startGame() {
      game = new Chess();
      board.position('start');
      whiteTime = blackTime = 600;
      timerActive = true;
      updateTimers();
      updateStatus();
      startTimer();
    }

    function resetGame() {
      stopTimer();
      startGame();
    }

    $(function () {
      game = new Chess();

      board = Chessboard('board', {
        draggable: true,
        position: 'start',
        onDragStart,
        onDrop,
        onSnapEnd,
        orientation: 'white',
        onSquareClick
      });

      $('#startBtn').click(startGame);
      $('#toggleTimerBtn').click(() => timerActive = !timerActive);
      $('#resetBtn').click(resetGame);

      startGame();
    });

    Chessboard.prototype.removeGreySquares = function () {
      this.setSquareStyles({});
    };
  </script>
</body>
</html>
